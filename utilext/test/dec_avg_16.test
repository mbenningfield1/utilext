#===============================================================================
#
# Written by: Mark Benningfield
#
# LICENSE: Public Domain -- see the file LICENSE.txt
#
#===============================================================================
#
# Tests for the multi-arg dec_avg() function using UTF-16 database encoding
#
#===============================================================================
 
source errors.tcl
setup_16 db


test null_all {Verify a NULL return for all-NULL args} -body {
  return [elem0 [db eval {select dec_avg(NULL, NULL, NULL);}]]
} -result NULL


test null_any {Verify a NULL arg is ignored if non-NULL args are present} -body {
  return [elem0 [db eval {select dec_avg('3.25', '4.65', NULL);}]]
} -result 3.95


test args_zero {Verify NULL return with zero arguments} -body {
  return [elem0 [db eval {select dec_avg();}]]
} -result NULL


test args_one {Verify result with only one argument} -body {
  return [elem0 [db eval {select dec_avg('3.24');}]]
} -result 3.24


test normal {Take the average of some numbers} -body {
  return [elem0 [db eval {select dec_avg('1.5', '3.25', '4.75');}]]
} -result 3.1666666666666666666666666667


test invalid {Verify parse error on non-numeric input} -body {
  db eval {select dec_avg('4.8', '6.5', 'fred');}
} -returnCodes 1 -result $SqliteFormat


test max_args {Verify that we can handle up to the limit of function args} -body {
  set values {
  485.4853     878.32101   207.39902    32553.21921  31744.33898
  -38290.11222 36929.5214  29275.12061  24962.48063  35481.49579
  11188.11653  41733.43759 49339.1801   44934.38219  21423.33123
  14671.8785   19670.3517  48682.45342  23472.41913  11300.13747
  47100.15721  13112.20973 48049.3098   14492.33581  10115.21206
  16063.43550  16152.35846 1549.38831   13119.7118   32762.48406
  44967.44333  -499.48620  19227.29505  41552.33412  6531.33932
  38589.33048  36763.21735 2480.45466   48541.20761  45710.46241
  37308.11353  28105.217   17061.21120  42633.33824  1968.9851
  32223.16354  9152.12894  18779.2767   15223.14492  1746.18545
  11546.31080  27050.26182 32616.33014  6788.44416   33366.6083
  40290.42358  11408.36520 -11099.33615 16229.282    31559.48107
  36871.7729   31445.46680 1710.22236   23897.23869  2957.49712
  30244.34049  19015.27166 34696.6229   34302.1923   17600.34047
  14333.48217  458.45885   19561.39864  4947.22632   1795.35163
  36537.14941  32932.3639  31673.3818   49634.30370  24473.10381
  9118.32918   41459.33653 25838.6241   -23344.34241 1824.4871
  49312.14307  32681.47512 33775.38653  7271.35560   27119.11845
  17289.1265   22075.17794 13176.15303  1118.15377   45492.30879
  6594.3933    27450.7220  24929.31414  6759.16804   20047.13321
  16521.20705  20808.46924 35851.22231  32260.35420  19863.43019
  46546.14075  3252.12628  43092.7853   10844.23666  -20478.10535
  5124.7967    38749.20944 48276.45380  36856.25462  22583.2361
  31895.40467  15513.13799 45324.46584  30457.25150  31942.40945
  33043.15697  45513.2473  34333.42519  682.14822    14128.17077
  20571.33092  46326.9512
  }
  
  set avgs {
  485.4853 681.903155 523.73511 8531.106135 13173.752704
  4596.4418833333333333333333333  9215.453242857142857142857143
  11722.91166375                  13193.974882222222222222222222
  15422.726973                    15037.762387272727272727272727
  17262.4019875                   19729.846457692307692307692308
  21530.170438571428571428571429  21523.047824666666666666666667
  21094.849741875                 21011.055739411764705882352941
  22548.355610555555555555555556  22596.990532631578947368421053
  22032.1478795                   23225.86260952380952380952381
  22766.151115                    23865.418883913043478260869565
  23474.873755833333333333333333  22940.487288
  22675.985296153846153846153846  22434.369487407407407407407407
  21688.4773025                   21393.00263
  21771.985344333333333333333333  22520.225924516129032258064516
  21800.859920625                 21722.873106363636363636363636
  22306.092547941176470588235294  21855.385312857142857142857143
  22320.217123055555555555555556  22710.568480540540540540540541
  22178.197064210526315789473684  22854.171693589743589743589744
  23425.5789615                   23764.17736560975609756097561
  23867.535452142857142857142857  23709.248841627906976744186047
  24139.3417825                   23646.667189555555555555555556
  23833.112762391304347826086957  23520.751404468085106382978723
  23421.970681458333333333333333  23254.647706734693877551020408
  22824.4784616                   22603.337919215686274509803922
  22688.855686538461538461538462  22876.166525283018867924528302
  22578.245740740740740740740741  22774.397787272727272727272727
  23087.183962142857142857142857  22882.292404912280701754385965
  22296.402257413793103448275862  22193.569710677966101694915254
  22349.668233333333333333333333  22587.735522950819672131147541
  22730.602156451612903225806452  22396.945334285714285714285714
  22420.38741796875               22120.958336461538461538461538
  22244.039884242424242424242424  22195.849313731343283582089552
  22379.684219411764705882352941  22552.474191594202898550724638
  22481.729424142857142857142857  22366.965378309859154929577465
  22062.680565416666666666666667  22028.416429452054794520547945
  21797.589536081081081081081081  21530.893030666666666666666667
  21728.3437725                   21873.850527402597402597402597
  21999.485543717948717948717949  22349.293368481012658227848101
  22375.840999                    22212.168013580246913580246914
  22446.889580853658536585365854  22487.753852168674698795180723
  21942.133658571428571428571429  21705.455463764705882352941176
  22026.463459186046511627906977  22148.934857586206896551724138
  22281.053626590909090909090909  22112.405334157303370786516854
  22168.035479888888888888888889  22114.421095494505494505494505
  22113.994539456521739130434783  22017.888716774193548387096774
  21795.551110957446808510638298  22044.990665473684210526315789
  21884.046942916666666666666667  21941.435345567010309278350515
  21971.923904693877551020408163  21818.259704040404040404040404
  21800.5484391                   21748.277732277227722772277228
  21739.063923529411764705882353  21876.07517
  21975.924006826923076923076923  21955.805018095238095238095238
  22187.789317452830188679245283  22010.820504018691588785046729
  22206.023881759259259259259259  22101.787301743119266055045872
  21714.697368545454545454545455  21565.238803963963963963963964
  21718.667113214285714285714286  21953.691774159292035398230088
  22084.41600964912280701754386   22088.753575652173913043478261
  22173.293671293103448275862069  22116.369263760683760683760684
  22313.048048305084745762711864  22381.486732773109243697478992
  22461.16108875                  22548.615600165289256198347107
  22736.850286229508196721311475  22831.131383008130081300813008
  22652.510551048387096774193548  22584.3158328
  22568.339762063492063492063492  22755.415442677165354330708661
  }
  set n [db limit function_arg -1]
  for {set i 1} {$i < $n} {incr i} {
    set args [string cat [join [lrange $values 0 $i] {', '}] "');"]
    set query [string cat "select dec_avg('" $args]
    set a [elem0 [db eval $query]]
    set b [lindex $avgs $i]
    if {$a ne $b} {puts "test_max_args failed with i = $i"}
  }
} -output {} -result {}


db close
tcltest::cleanupTests
