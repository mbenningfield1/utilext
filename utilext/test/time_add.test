#===============================================================================
#
# Written by: Mark Benningfield
#
# LICENSE: Public Domain -- see the file LICENSE.txt
#
#===============================================================================
#
# Tests for the timespan_add() function
# 
#===============================================================================

source errors.tcl
setup db


test null_all {Verify that NULL is returned with all args NULL} -body {
  return [elem0 [db eval {select timespan_add(NULL, NULL, NULL, NULL);}]]
} -result NULL


test null_any {Verify that a NULL arg is ignored if non-NULL args are present} -body {
  return [elem0 [db eval {select timespan_add(444487607, -596084398, NULL);}]]
} -result -151596791


test args_zero {Verify NULL return with zero arguments} -body {
  return [elem0 [db eval {select timespan_add();}]]
} -result NULL


test args_one {Verify result with only 1 argument} -body {
  return [elem0 [db eval {select timespan_add(23442334);}]]
} -result 23442334


test pos_overflow {Verify error on positive overflow} -body {
  db eval {select timespan_add($TIME_MAX, 1);}
} -returnCodes 1 -result $SqliteTooBig


test neg_overflow {Verify error on negative overflow} -body {
  db eval {select timespan_add($TIME_MIN, -1);}
} -returnCodes 1 -result $SqliteTooBig


test normal {Just add up some numbers} -body {
  return [elem0 [db eval {select timespan_add(444487607, -596084398, 107217565);}]]
} -result -44379226


test max_args {Verify that we can handle up to the limit of function args} -body {
  set values {
    987386441   527791854   766855116   -385002703  406767332   -432981754
    -832325456  571751473   -803590871  302046253   -473267289  -872047476
    332463839   406050128   396229648   151674014   790927773   358078034
    160637506   -660070738  195827803   -487578324  890927688   -722686239
    -581568645  806782769   611660648   926339483   -341823230  -260820282
    522610579   -469052995  -347316207  340996441   -873098467  263835589
    529352933   79028840    343234548   459783730   -309116053  51423895
    545808071   240762145   666438210   583456998   780086352   -41772506
    -456766465  115201293   386845926   -103087764  259567706   608474958
    -113600060  -92562188   -187270929  610975821   -577172697  733191337
    117753736   -381595343  -67335607   790413582   -633515913  501325257
    -951155004  -949361940  -906535647  277514692   937079379   -108815958
    -541193027  -615648960  360786506   178953110   -174494320  -315610115
    -298467645  -395507034  -726060635  129552323   357870818   653916394
    358224050   455425805   -767323645  261446314   -108621295  -216274067
    437961765   -503115949  -398486792  672408153   -39621946   -540793244 
    31419018    789022242   -63346959   377144991   652491043   169199543
    -926169953  -525500027  -280131224  363074022   -91435076   827778251
    753350425   200706601   788339517   121353281   -421352622  -678605379
    889896786   -942014185  58837192    995396472   209585827   226011637
    36141502    -951390492  65107344    711763429   283907093   497967776
    -252938439
  }
  
  set sums {
    987386441   1515178295  2282033411  1897030708 2303798040 1870816286
    1038490830  1610242303  806651432   1108697685 635430396  -236617080
    95846759    501896887   898126535   1049800549 1840728322 2198806356
    2359443862  1699373124  1895200927  1407622603 2298550291 1575864052
    994295407   1801078176  2412738824  3339078307 2997255077 2736434795
    3259045374  2789992379  2442676172  2783672613 1910574146 2174409735
    2703762668  2782791508  3126026056  3585809786 3276693733 3328117628
    3873925699  4114687844  4781126054  5364583052 6144669404 6102896898
    5646130433  5761331726  6148177652  6045089888 6304657594 6913132552
    6799532492  6706970304  6519699375  7130675196 6553502499 7286693836
    7404447572  7022852229  6955516622  7745930204 7112414291 7613739548
    6662584544  5713222604  4806686957  5084201649 6021281028 5912465070
    5371272043  4755623083  5116409589  5295362699 5120868379 4805258264
    4506790619  4111283585  3385222950  3514775273 3872646091 4526562485
    4884786535  5340212340  4572888695  4834335009 4725713714 4509439647
    4947401412  4444285463  4045798671  4718206824 4678584878 4137791634
    4169210652  4958232894  4894885935  5272030926 5924521969 6093721512
    5167551559  4642051532  4361920308  4724994330 4633559254 5461337505
    6214687930  6415394531  7203734048  7325087329 6903734707 6225129328
    7115026114  6173011929  6231849121  7227245593 7436831420 7662843057
    7698984559  6747594067  6812701411  7524464840 7808371933 8306339709
    8053401270 
  }
  set n [db limit function_arg -1]
  for {set i 1} {$i < $n} {incr i} {
    set args [string cat [join [lrange $values 0 $i] {', '}] "');"]
    set query [string cat "select timespan_add('" $args]
    set a [db eval $query]
    set b [lindex $sums $i]
    if {$a != $b} {puts "test_max_args failed in test_add i = $i"}
  }
} -output {} -result {}


db close
tcltest::cleanupTests
